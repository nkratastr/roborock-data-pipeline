version: '3.8'

services:
  roborock-pipeline:
    build: .
    container_name: roborock-data-pipeline
    restart: unless-stopped
    
    environment:
      # Set your Roborock email here or use .env file
      - ROBOROCK_EMAIL=${ROBOROCK_EMAIL}
      # Sync interval in seconds (default: 3600 = 1 hour)
      - SYNC_INTERVAL=${SYNC_INTERVAL:-3600}
      # Ensure Python output is not buffered (so logs show immediately)
      - PYTHONUNBUFFERED=1
    
    volumes:
      # Mount config directory for credentials and state persistence
      - ./config:/app/config
    
    # Run record_sync mode - checks for new cleaning records hourly
    command: >
      python pipeline.py 
      --mode record_sync 
      --interval ${SYNC_INTERVAL:-3600}

    # Optional: check health
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
